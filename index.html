<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Juego de Velocidad Lectora con Niveles</title>
    <style>
        :root {
            --primary: #4b7bec;
            --secondary: #a55eea;
            --accent: #fd9644;
            --light: #f0f8ff;
            --dark: #2c3e50;
            --success: #2bcbba;
            --warning: #fed330;
            --danger: #fc5c65;
            --text-bg: #f9f9f9;
            --easy: #2bcbba;
            --medium: #fed330;
            --hard: #fc5c65;
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            color: var(--dark);
            line-height: 1.6;
            min-height: 100vh;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        
        .container {
            width: 100%;
            max-width: 900px;
            background: white;
            border-radius: 20px;
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            margin: 20px;
        }
        
        header {
            background: linear-gradient(90deg, var(--primary) 0%, var(--secondary) 100%);
            color: white;
            padding: 25px;
            text-align: center;
        }
        
        h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }
        
        .subtitle {
            font-size: 1.2rem;
            opacity: 0.9;
        }
        
        .content {
            padding: 30px;
        }
        
        .info-box {
            background-color: #e8f4fc;
            border-left: 5px solid var(--primary);
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 25px;
        }
        
        .level-selector {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin: 20px 0;
            flex-wrap: wrap;
        }
        
        .level-btn {
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .level-btn.easy {
            background-color: var(--easy);
            color: white;
        }
        
        .level-btn.medium {
            background-color: var(--medium);
            color: var(--dark);
        }
        
        .level-btn.hard {
            background-color: var(--hard);
            color: white;
        }
        
        .level-btn.active {
            transform: scale(1.05);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }
        
        .mode-selector {
            display: flex;
            justify-content: center;
            align-items: center;
            margin: 20px 0;
            gap: 15px;
        }
        
        .switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 30px;
        }
        
        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--primary);
            transition: .4s;
            border-radius: 34px;
        }
        
        .slider:before {
            position: absolute;
            content: "";
            height: 22px;
            width: 22px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        
        input:checked + .slider {
            background-color: var(--success);
        }
        
        input:checked + .slider:before {
            transform: translateX(30px);
        }
        
        .mode-label {
            font-weight: bold;
        }
        
        .text-container {
            position: relative;
            margin: 30px 0;
        }
        
        .text-display {
            font-size: 24px;
            line-height: 1.6;
            padding: 30px;
            background-color: var(--text-bg);
            border-radius: 15px;
            min-height: 180px;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            box-shadow: inset 0 0 10px rgba(0, 0, 0, 0.05);
            transition: all 0.3s ease;
            position: relative;
            z-index: 2;
        }
        
        .word-count {
            position: absolute;
            bottom: 10px;
            right: 15px;
            font-size: 14px;
            color: #777;
        }
        
        .controls {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin: 20px 0;
            flex-wrap: wrap;
        }
        
        button {
            background-color: var(--primary);
            color: white;
            border: none;
            padding: 15px 30px;
            font-size: 18px;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
        }
        
        button:active {
            transform: translateY(0);
        }
        
        button:disabled {
            background-color: #a5b1c2;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        #startButton {
            background-color: var(--success);
        }
        
        #stopButton {
            background-color: var(--danger);
        }
        
        .progress-container {
            margin: 30px 0;
        }
        
        .progress-bar {
            height: 25px;
            background-color: #f1f1f1;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: inset 0 0 5px rgba(0, 0, 0, 0.1);
        }
        
        .progress {
            height: 100%;
            background: linear-gradient(90deg, var(--primary) 0%, var(--secondary) 100%);
            width: 0%;
            transition: width 0.5s;
            border-radius: 15px;
        }
        
        .status {
            display: flex;
            justify-content: space-between;
            margin-top: 10px;
            font-weight: bold;
        }
        
        .mic-status {
            text-align: center;
            margin: 15px 0;
            font-size: 18px;
            color: var(--primary);
            min-height: 27px;
        }
        
        .motivational-message {
            text-align: center;
            margin: 15px 0;
            padding: 15px;
            background-color: #e8f4fc;
            border-radius: 10px;
            font-style: italic;
            display: none;
        }
        
        .results {
            display: none;
            margin-top: 30px;
            padding: 25px;
            background: linear-gradient(135deg, #f6f9fc 0%, #eef2f7 100%);
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
        }
        
        .result-title {
            color: var(--primary);
            margin-bottom: 20px;
        }
        
        .metric {
            display: inline-block;
            margin: 15px;
            padding: 20px;
            background: white;
            border-radius: 12px;
            min-width: 200px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
        }
        
        .metric-value {
            font-size: 2.5rem;
            font-weight: bold;
            color: var(--primary);
            margin: 10px 0;
        }
        
        .metric-label {
            font-size: 1.1rem;
            color: var(--dark);
        }
        
        .evaluation {
            margin: 25px 0;
            padding: 20px;
            background-color: white;
            border-radius: 12px;
            font-size: 1.2rem;
        }
        
        .level-progress {
            display: flex;
            justify-content: center;
            margin: 20px 0;
            gap: 10px;
        }
        
        .level-dot {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background-color: #ddd;
            transition: all 0.3s;
        }
        
        .level-dot.completed {
            background-color: var(--success);
            transform: scale(1.2);
        }
        
        .level-dot.current {
            background-color: var(--primary);
            transform: scale(1.2);
        }
        
        .requirements {
            margin-top: 40px;
            padding: 25px;
            background-color: #f8f9fa;
            border-radius: 15px;
        }
        
        .requirements h3 {
            color: var(--primary);
            margin-bottom: 15px;
        }
        
        .requirements ul {
            list-style-type: none;
        }
        
        .requirements li {
            margin-bottom: 10px;
            padding-left: 25px;
            position: relative;
        }
        
        .requirements li:before {
            content: "‚Ä¢";
            color: var(--primary);
            font-weight: bold;
            position: absolute;
            left: 0;
        }
        
        @media (max-width: 768px) {
            .container {
                border-radius: 15px;
            }
            
            h1 {
                font-size: 2rem;
            }
            
            .text-display {
                font-size: 20px;
                padding: 20px;
            }
            
            button {
                width: 100%;
                justify-content: center;
            }
            
            .metric {
                min-width: 150px;
                margin: 10px 5px;
            }
        }
        
        .confetti {
            position: absolute;
            width: 10px;
            height: 10px;
            background-color: var(--accent);
            opacity: 0;
            z-index: 1;
        }
        
        @keyframes confettiFall {
            0% { 
                transform: translateY(-100px) rotate(0deg); 
                opacity: 1;
            }
            100% { 
                transform: translateY(500px) rotate(360deg); 
                opacity: 0;
            }
        }
        
        .completed-animation {
            animation: pulse 2s infinite;
            text-align: center;
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--success);
            margin: 20px 0;
            display: none;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üèéÔ∏è Carrera de Lectura üèéÔ∏è</h1>
            <p class="subtitle">Mide y mejora tu velocidad lectora</p>
        </header>
        
        <div class="content">
            <div class="info-box">
                <p>Para ni√±os de 10 a√±os, se espera una velocidad m√≠nima de <strong>130 palabras por minuto</strong> con buena comprensi√≥n. ¬°Practica y mejora tu velocidad!</p>
            </div>
            
            <div class="level-selector">
                <button class="level-btn easy active" data-level="easy">Nivel F√°cil</button>
                <button class="level-btn medium" data-level="medium">Nivel Medio</button>
                <button class="level-btn hard" data-level="hard">Nivel Dif√≠cil</button>
            </div>
            
            <div class="mode-selector">
                <span class="mode-label">Modo Manual</span>
                <label class="switch">
                    <input type="checkbox" id="modeToggle">
                    <span class="slider"></span>
                </label>
                <span class="mode-label">Modo Autom√°tico</span>
            </div>
            
            <div class="level-progress">
                <div class="level-dot" data-level="1"></div>
                <div class="level-dot" data-level="2"></div>
                <div class="level-dot" data-level="3"></div>
            </div>
            
            <div class="text-container">
                <div class="text-display" id="textDisplay">
                    Selecciona un nivel y presiona "Comenzar" para iniciar la prueba de lectura
                </div>
                <div class="word-count" id="wordCount"></div>
            </div>
            
            <div class="progress-container">
                <div class="progress-bar">
                    <div class="progress" id="progressBar"></div>
                </div>
                <div class="status">
                    <span>Tiempo: <span id="timeElapsed">0</span>s</span>
                    <span>Palabras: <span id="wordsCount">0</span>/<span id="totalWords">0</span></span>
                </div>
            </div>
            
            <div class="mic-status" id="micStatus"></div>
            <div class="motivational-message" id="motivationalMessage"></div>
            
            <div class="controls">
                <button id="startButton">
                    <span>üé§</span> Comenzar
                </button>
                <button id="stopButton" disabled>
                    <span>‚èπÔ∏è</span> Detener
                </button>
            </div>
            
            <div class="completed-animation" id="completedAnimation">
                ¬°Felicidades! Has completado todos los niveles üéâ
            </div>
            
            <div class="results" id="results">
                <h2 class="result-title">Resultados de la Prueba</h2>
                
                <div class="metric">
                    <div class="metric-value" id="wordsPerMinute">0</div>
                    <div class="metric-label">Palabras por minuto</div>
                </div>
                
                <div class="metric">
                    <div class="metric-value" id="accuracy">0%</div>
                    <div class="metric-label">Precisi√≥n</div>
                </div>
                
                <div class="metric">
                    <div class="metric-value" id="readingTime">0s</div>
                    <div class="metric-label">Tiempo de lectura</div>
                </div>
                
                <div class="evaluation" id="evaluation">
                    ¬°Sigue practicando para mejorar tu velocidad!
                </div>
                
                <button id="retryButton">
                    <span>üîÑ</span> Intentar de nuevo
                </button>
                <button id="nextButton">
                    <span>‚û°Ô∏è</span> Siguiente texto
                </button>
            </div>
            
            <div class="requirements">
                <h3>Requisitos del Sistema</h3>
                <ul>
                    <li>Conexi√≥n HTTPS (obligatoria para el reconocimiento de voz)</li>
                    <li>Navegador compatible: Chrome, Edge, Firefox o Safari</li>
                    <li>Micr√≥fono funcionando correctamente (para modo autom√°tico)</li>
                    <li>Permitir el acceso al micr√≥fono cuando el navegador lo solicite</li>
                </ul>
            </div>
        </div>
    </div>

    <script>
        // Textos para cada nivel (adaptados para ni√±os de 9-10 a√±os)
        const textsByLevel = {
            easy: [
                "El sol brilla en el cielo azul. Los p√°jaros cantan en los √°rboles. Los ni√±os juegan en el parque con una pelota roja. Hace un d√≠a muy bonito y todos est√°n contentos.",
                "Mar√≠a tiene un perrito peque√±o que se llama Luna. A Luna le gusta correr en el jard√≠n y jugar con su pelota favorita. Por las tardes, Mar√≠a y Luna pasean por el barrio.",
                "En la granja hay muchos animales. Los pollitos p√≠an, las vacas dan leche y los cerdos juegan en el lodo. El granjero da de comer a todos cada ma√±ana."
            ],
            medium: [
                "Los exploradores se adentraron en el bosque misterioso buscando antiguas ruinas ocultas entre la vegetaci√≥n. Con sus mapas y br√∫julas, avanzaron cuidadosamente por el sendero cubierto de hojas secas.",
                "La abuela preparaba cada domingo un delicioso pastel de manzana con canela. Su casa se llenaba de un aroma dulce que atra√≠a a todos los nietos hacia la cocina, donde esperaban ansiosos el postre.",
                "El equipo de cient√≠ficos descubri√≥ una nueva especie de mariposa en la selva tropical. Sus alas ten√≠an colores vibrantes que nunca antes se hab√≠an documentado en ning√∫n libro de biolog√≠a."
            ],
            hard: [
                "La civilizaci√≥n egipcia antigua desarroll√≥ avanzados sistemas de irrigaci√≥n que permitieron la agricultura en las √°ridas tierras cercanas al r√≠o Nilo. Construyeron impresionantes pir√°mides que a√∫n hoy siguen maravillando a arque√≥logos y turistas.",
                "Los fen√≥menos meteorol√≥gicos extremos, como huracanes y tornados, se han intensificado debido al cambio clim√°tico global. Los investigadores analizan datos satelitales para mejorar los sistemas de alerta temprana.",
                "La revoluci√≥n industrial del siglo XVIII transform√≥ profundamente la econom√≠a y la sociedad europea. La invenci√≥n de m√°quinas a vapor permiti√≥ la producci√≥n en masa y cambi√≥ para siempre las relaciones laborales."
            ]
        };
        
        // Mensajes motivacionales
        const motivationalMessages = [
            "¬°Excelente lectura! Sigue as√≠.",
            "¬°Gran trabajo! Cada d√≠a lees mejor.",
            "¬°Incre√≠ble! Tu esfuerzo est√° dando resultados.",
            "¬°Fant√°stico! Eres un lector excepcional.",
            "¬°Maravilloso! Tu velocidad mejora constantemente.",
            "¬°Impresionante! Nada puede detenerte ahora.",
            "¬°Asombroso! Tu dedicaci√≥n es admirable."
        ];
        
        // Variables del juego
        let currentText = "";
        let startTime, endTime;
        let recognition;
        let wordsRead = 0;
        let correctWords = 0;
        let isTesting = false;
        let progressInterval;
        let isManualMode = false;
        let audioContext;
        let currentLevel = "easy";
        let currentTextIndex = 0;
        let completedLevels = { easy: [], medium: [], hard: [] };
        
        // Elementos DOM
        const startButton = document.getElementById('startButton');
        const stopButton = document.getElementById('stopButton');
        const retryButton = document.getElementById('retryButton');
        const nextButton = document.getElementById('nextButton');
        const modeToggle = document.getElementById('modeToggle');
        const levelButtons = document.querySelectorAll('.level-btn');
        const levelDots = document.querySelectorAll('.level-dot');
        const motivationalMessage = document.getElementById('motivationalMessage');
        const completedAnimation = document.getElementById('completedAnimation');
        
        // Inicializar la aplicaci√≥n
        function initApp() {
            // Configurar event listeners
            startButton.addEventListener('click', startTest);
            stopButton.addEventListener('click', stopTest);
            retryButton.addEventListener('click', resetTest);
            nextButton.addEventListener('click', nextText);
            modeToggle.addEventListener('change', toggleMode);
            
            levelButtons.forEach(btn => {
                btn.addEventListener('click', () => {
                    changeLevel(btn.dataset.level);
                });
            });
            
            // Inicializar audio
            try {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
            } catch (e) {
                console.error('Web Audio API no es compatible con este navegador:', e);
            }
            
            // Verificar si estamos en HTTPS
            if (location.protocol !== 'https:') {
                document.getElementById('micStatus').innerHTML = 
                    '<span style="color: var(--danger);">‚ö†Ô∏è Esta aplicaci√≥n requiere HTTPS para funcionar correctamente.</span>';
            }
            
            // Actualizar la UI inicial
            updateLevelProgress();
        }
        
        // Cambiar nivel de dificultad
        function changeLevel(level) {
            currentLevel = level;
            currentTextIndex = 0;
            
            // Actualizar botones de nivel
            levelButtons.forEach(btn => {
                if (btn.dataset.level === level) {
                    btn.classList.add('active');
                } else {
                    btn.classList.remove('active');
                }
            });
            
            // Reiniciar la prueba
            resetTest();
            updateLevelProgress();
        }
        
        // Cambiar modo (autom√°tico/manual)
        function toggleMode() {
            isManualMode = !modeToggle.checked;
            resetTest();
            
            if (isManualMode) {
                document.getElementById('micStatus').textContent = 'Modo manual: el profesor calcular√° el tiempo';
            } else {
                document.getElementById('micStatus').textContent = 'Modo autom√°tico: el sistema escuchar√° la lectura';
            }
        }
        
        // Actualizar progreso de niveles
        function updateLevelProgress() {
            levelDots.forEach((dot, index) => {
                dot.classList.remove('completed', 'current');
                
                if (index < currentTextIndex) {
                    dot.classList.add('completed');
                } else if (index === currentTextIndex) {
                    dot.classList.add('current');
                }
            });
            
            // Mostrar animaci√≥n si se completaron todos los niveles
            const allCompleted = Object.values(completedLevels).every(level => level.length === 3);
            completedAnimation.style.display = allCompleted ? 'block' : 'none';
            
            if (allCompleted) {
                playCelebrationSound();
                createConfetti();
            }
        }
        
        // Inicializar el reconocimiento de voz
        function initSpeechRecognition() {
            window.SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            
            if (!window.SpeechRecognition) {
                alert("Lo sentimos, tu navegador no soporta reconocimiento de voz. Prueba con Chrome o Edge.");
                return false;
            }
            
            recognition = new SpeechRecognition();
            recognition.lang = 'es-ES';
            recognition.continuous = true;
            recognition.interimResults = true;
            
            recognition.onresult = function(event) {
                if (!isTesting || isManualMode) return;
                
                let interimTranscript = '';
                let finalTranscript = '';
                
                for (let i = event.resultIndex; i < event.results.length; i++) {
                    const transcript = event.results[i][0].transcript;
                    if (event.results[i].isFinal) {
                        finalTranscript += transcript;
                    } else {
                        interimTranscript += transcript;
                    }
                }
                
                if (finalTranscript) {
                    processSpeech(finalTranscript);
                }
            };
            
            recognition.onerror = function(event) {
                console.error('Error en reconocimiento de voz:', event.error);
                document.getElementById('micStatus').textContent = 'Error: ' + event.error;
            };
            
            recognition.onend = function() {
                if (isTesting && !isManualMode) {
                    try {
                        recognition.start();
                    } catch (e) {
                        console.error('Error al reiniciar reconocimiento:', e);
                    }
                }
            };
            
            return true;
        }
        
        // Comenzar la prueba
        function startTest() {
            if (!isManualMode && !initSpeechRecognition()) return;
            
            // Obtener texto seg√∫n nivel e √≠ndice
            currentText = textsByLevel[currentLevel][currentTextIndex];
            const totalWords = currentText.split(/\s+/).length;
            
            // Mostrar texto
            const textDisplay = document.getElementById('textDisplay');
            textDisplay.textContent = currentText;
            
            // Mostrar conteo de palabras
            document.getElementById('totalWords').textContent = totalWords;
            document.getElementById('wordCount').textContent = `${totalWords} palabras`;
            
            // Reiniciar variables
            wordsRead = 0;
            correctWords = 0;
            startTime = new Date();
            isTesting = true;
            
            // Actualizar UI
            startButton.disabled = true;
            stopButton.disabled = false;
            document.getElementById('results').style.display = 'none';
            document.getElementById('progressBar').style.width = '0%';
            
            if (isManualMode) {
                document.getElementById('micStatus').textContent = '¬°Empieza a leer ahora!';
            } else {
                document.getElementById('micStatus').textContent = 'Escuchando... Habla ahora!';
            }
            
            document.getElementById('wordsCount').textContent = '0';
            document.getElementById('timeElapsed').textContent = '0';
            
            // Reproducir sonido de inicio
            playStartSound();
            
            // Iniciar reconocimiento de voz si est√° en modo autom√°tico
            if (!isManualMode) {
                try {
                    recognition.start();
                } catch (error) {
                    console.error("Error al iniciar reconocimiento:", error);
                }
            }
            
            // Actualizar barra de progreso cada segundo
            progressInterval = setInterval(updateProgress, 1000);
        }
        
        // Actualizar progreso
        function updateProgress() {
            if (!isTesting) {
                clearInterval(progressInterval);
                return;
            }
            
            const elapsedTime = Math.floor((new Date() - startTime) / 1000);
            document.getElementById('timeElapsed').textContent = elapsedTime;
            
            const progressPercent = Math.min(100, (elapsedTime / 60) * 100);
            document.getElementById('progressBar').style.width = progressPercent + '%';
            
            // Detener autom√°ticamente despu√©s de 120 segundos
            if (elapsedTime > 120) {
                stopTest();
            }
        }
        
        // Procesar el habla detectada
        function processSpeech(transcript) {
            const expectedWords = currentText.toLowerCase().replace(/[.,]/g, '').split(/\s+/);
            const spokenWords = transcript.toLowerCase().replace(/[.,]/g, '').split(/\s+/);
            
            wordsRead = spokenWords.length;
            document.getElementById('wordsCount').textContent = wordsRead;
            
            // Verificar palabras correctas
            correctWords = 0;
            for (let i = 0; i < spokenWords.length; i++) {
                if (i < expectedWords.length && spokenWords[i] === expectedWords[i]) {
                    correctWords++;
                }
            }
        }
        
        // Detener la prueba
        function stopTest() {
            if (!isTesting) return;
            
            isTesting = false;
            endTime = new Date();
            clearInterval(progressInterval);
            
            // Detener reconocimiento de voz si est√° activo
            if (!isManualMode) {
                try {
                    recognition.stop();
                } catch (error) {
                    console.error("Error al detener reconocimiento:", error);
                }
            }
            
            // Calcular resultados
            const timeInSeconds = (endTime - startTime) / 1000;
            const timeInMinutes = timeInSeconds / 60;
            const totalWords = currentText.split(/\s+/).length;
            
            // En modo manual, calcular palabras le√≠das basado en el texto completo
            if (isManualMode) {
                wordsRead = totalWords;
                correctWords = totalWords; // Asumimos que se leyeron todas correctamente en modo manual
            }
            
            const wordsPerMinute = Math.round(wordsRead / timeInMinutes);
            const accuracy = wordsRead > 0 ? Math.round((correctWords / wordsRead) * 100) : 0;
            
            // Evaluar rendimiento
            let evaluation = "";
            let minimumWPM = 130;
            
            // Ajustar expectativas seg√∫n nivel
            if (currentLevel === "easy") minimumWPM = 110;
            if (currentLevel === "hard") minimumWPM = 150;
            
            if (wordsPerMinute >= minimumWPM && accuracy >= 85) {
                evaluation = "¬°Excelente! Tu velocidad de lectura es muy buena para este nivel.";
                // Marcar texto como completado
                if (!completedLevels[currentLevel].includes(currentTextIndex)) {
                    completedLevels[currentLevel].push(currentTextIndex);
                }
                
                // Mostrar mensaje motivacional
                showMotivationalMessage();
            } else if (wordsPerMinute >= minimumWPM - 20 && accuracy >= 75) {
                evaluation = "Buen trabajo. Sigue practicando para mejorar tu velocidad y precisi√≥n.";
            } else {
                evaluation = "Sigue practicando. La lectura mejora con la pr√°ctica constante.";
            }
            
            // Mostrar resultados
            document.getElementById('wordsPerMinute').textContent = wordsPerMinute;
            document.getElementById('accuracy').textContent = accuracy + '%';
            document.getElementById('readingTime').textContent = timeInSeconds.toFixed(1) + 's';
            document.getElementById('evaluation').textContent = evaluation;
            document.getElementById('results').style.display = 'block';
            
            // Actualizar UI
            startButton.disabled = false;
            stopButton.disabled = true;
            
            if (isManualMode) {
                document.getElementById('micStatus').textContent = 'Prueba finalizada';
            } else {
                document.getElementById('micStatus').textContent = 'Prueba finalizada - ' + correctWords + ' de ' + wordsRead + ' palabras correctas';
            }
            
            // Actualizar progreso de niveles
            updateLevelProgress();
            
            // Reproducir sonido de celebraci√≥n y mostrar confeti si fue exitoso
            if (wordsPerMinute >= minimumWPM && accuracy >= 85) {
                playCelebrationSound();
                createConfetti();
            }
        }
        
        // Mostrar mensaje motivacional
        function showMotivationalMessage() {
            const randomMessage = motivationalMessages[Math.floor(Math.random() * motivationalMessages.length)];
            motivationalMessage.textContent = randomMessage;
            motivationalMessage.style.display = 'block';
            
            // Ocultar despu√©s de 5 segundos
            setTimeout(() => {
                motivationalMessage.style.display = 'none';
            }, 5000);
        }
        
        // Avanzar al siguiente texto
        function nextText() {
            currentTextIndex = (currentTextIndex + 1) % 3;
            resetTest();
            updateLevelProgress();
        }
        
        // Reiniciar la prueba
        function resetTest() {
            const textDisplay = document.getElementById('textDisplay');
            textDisplay.textContent = 'Presiona "Comenzar" para iniciar la prueba';
            
            document.getElementById('results').style.display = 'none';
            document.getElementById('progressBar').style.width = '0%';
            document.getElementById('timeElapsed').textContent = '0';
            document.getElementById('wordsCount').textContent = '0';
            document.getElementById('totalWords').textContent = '0';
            document.getElementById('wordCount').textContent = '';
            motivationalMessage.style.display = 'none';
            
            if (isManualMode) {
                document.getElementById('micStatus').textContent = 'Modo manual: el profesor calcular√° el tiempo';
            } else {
                document.getElementById('micStatus').textContent = 'Modo autom√°tico: el sistema escuchar√° la lectura';
            }
            
            // Limpiar confeti
            const confettiElements = document.querySelectorAll('.confetti');
            confettiElements.forEach(el => el.remove());
        }
        
        // Reproducir sonido de inicio
        function playStartSound() {
            if (!audioContext) return;
            
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            
            oscillator.frequency.setValueAtTime(440, audioContext.currentTime);
            oscillator.frequency.setValueAtTime(523.25, audioContext.currentTime + 0.1);
            
            gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.3);
            
            oscillator.start();
            oscillator.stop(audioContext.currentTime + 0.3);
        }
        
        // Reproducir sonido de celebraci√≥n
        function playCelebrationSound() {
            if (!audioContext) return;
            
            try {
                // Crear una secuencia de tonos celebratorios
                const times = [0, 0.1, 0.2, 0.3, 0.4, 0.5];
                const frequencies = [523.25, 587.33, 659.25, 698.46, 783.99, 880];
                
                for (let i = 0; i < times.length; i++) {
                    const oscillator = audioContext.createOscillator();
                    const gainNode = audioContext.createGain();
                    
                    oscillator.connect(gainNode);
                    gainNode.connect(audioContext.destination);
                    
                    oscillator.frequency.setValueAtTime(frequencies[i], audioContext.currentTime);
                    
                    gainNode.gain.setValueAtTime(0.3, audioContext.currentTime + times[i]);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + times[i] + 0.1);
                    
                    oscillator.start(audioContext.currentTime + times[i]);
                    oscillator.stop(audioContext.currentTime + times[i] + 0.1);
                }
            } catch (e) {
                console.error('Error reproduciendo sonido:', e);
            }
        }
        
        // Crear efecto de confeti
        function createConfetti() {
            const container = document.querySelector('.text-container');
            const colors = ['#4b7bec', '#a55eea', '#fd9644', '#2bcbba', '#fed330', '#fc5c65'];
            
            for (let i = 0; i < 50; i++) {
                const confetti = document.createElement('div');
                confetti.className = 'confetti';
                confetti.style.left = Math.random() * 100 + '%';
                confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
                confetti.style.animation = `confettiFall ${Math.random() * 3 + 2}s linear forwards`;
                confetti.style.animationDelay = Math.random() * 2 + 's';
                
                container.appendChild(confetti);
            }
        }
        
        // Inicializar cuando se carga la p√°gina
        window.addEventListener('load', initApp);
    </script>
</body>
</html>
