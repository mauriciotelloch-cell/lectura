<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Juego de Velocidad Lectora con Niveles</title>
    <style>
        :root {
            --primary: #4b7bec;
            --secondary: #a55eea;
            --accent: #fd9644;
            --light: #f0f8ff;
            --dark: #2c3e50;
            --success: #2bcbba;
            --warning: #fed330;
            --danger: #fc5c65;
            --text-bg: #f9f9f9;
            --easy: #2bcbba;
            --medium: #fed330;
            --hard: #fc5c65;
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            color: var(--dark);
            line-height: 1.6;
            min-height: 100vh;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        
        .container {
            width: 100%;
            max-width: 900px;
            background: white;
            border-radius: 20px;
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            margin: 20px;
            position: relative;
        }
        
        header {
            background: linear-gradient(90deg, var(--primary) 0%, var(--secondary) 100%);
            color: white;
            padding: 25px;
            text-align: center;
        }
        
        h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }
        
        .subtitle {
            font-size: 1.2rem;
            opacity: 0.9;
        }
        
        .content {
            padding: 30px;
        }
        
        .level-section {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-bottom: 25px;
        }
        
        .level-buttons {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin: 15px 0;
            width: 100%;
            flex-wrap: wrap;
        }
        
        .level-btn {
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            flex: 1;
            min-width: 100px;
            max-width: 150px;
            text-align: center;
        }
        
        .level-btn.easy {
            background-color: var(--easy);
            color: white;
        }
        
        .level-btn.medium {
            background-color: var(--medium);
            color: var(--dark);
        }
        
        .level-btn.hard {
            background-color: var(--hard);
            color: white;
        }
        
        .level-btn.active {
            transform: scale(1.05);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }
        
        .mode-selector {
            display: flex;
            justify-content: center;
            align-items: center;
            margin: 15px 0;
            gap: 15px;
        }
        
        .switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 30px;
        }
        
        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--primary);
            transition: .4s;
            border-radius: 34px;
        }
        
        .slider:before {
            position: absolute;
            content: "";
            height: 22px;
            width: 22px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        
        input:checked + .slider {
            background-color: var(--success);
        }
        
        input:checked + .slider:before {
            transform: translateX(30px);
        }
        
        .mode-label {
            font-weight: bold;
        }
        
        .text-container {
            position: relative;
            margin: 30px 0;
        }
        
        .text-display {
            font-size: 24px;
            line-height: 1.6;
            padding: 30px;
            background-color: var(--text-bg);
            border-radius: 15px;
            min-height: 180px;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            box-shadow: inset 0 0 10px rgba(0, 0, 0, 0.05);
            transition: all 0.3s ease;
            position: relative;
            z-index: 2;
        }
        
        .word-count {
            position: absolute;
            bottom: 10px;
            right: 15px;
            font-size: 14px;
            color: #777;
        }
        
        .controls {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin: 20px 0;
            flex-wrap: wrap;
        }
        
        button {
            background-color: var(--primary);
            color: white;
            border: none;
            padding: 15px 30px;
            font-size: 18px;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
        }
        
        button:active {
            transform: translateY(0);
        }
        
        button:disabled {
            background-color: #a5b1c2;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        #startButton {
            background-color: var(--success);
        }
        
        #stopButton {
            background-color: var(--danger);
        }
        
        .progress-container {
            margin: 30px 0;
        }
        
        .progress-bar {
            height: 25px;
            background-color: #f1f1f1;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: inset 0 0 5px rgba(0, 0, 0, 0.1);
        }
        
        .progress {
            height: 100%;
            background: linear-gradient(90deg, var(--primary) 0%, var(--secondary) 100%);
            width: 0%;
            transition: width 0.5s;
            border-radius: 15px;
        }
        
        .status {
            display: flex;
            justify-content: space-between;
            margin-top: 10px;
            font-weight: bold;
        }
        
        .mic-status {
            text-align: center;
            margin: 15px 0;
            font-size: 18px;
            color: var(--primary);
            min-height: 27px;
        }
        
        .results-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        
        .results-content {
            background: white;
            padding: 20px;
            border-radius: 15px;
            max-width: 400px;
            width: 90%;
            text-align: center;
            box-shadow: 0 5px 25px rgba(0, 0, 0, 0.2);
            position: relative;
        }
        
        .close-results {
            position: absolute;
            top: 10px;
            right: 10px;
            background: none;
            border: none;
            font-size: 20px;
            cursor: pointer;
            color: var(--dark);
            padding: 5px;
        }
        
        .result-title {
            color: var(--primary);
            margin-bottom: 15px;
            font-size: 1.5rem;
        }
        
        .metric {
            margin: 10px 0;
            padding: 15px;
            background: linear-gradient(135deg, #f6f9fc 0%, #eef2f7 100%);
            border-radius: 10px;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.05);
        }
        
        .metric-value {
            font-size: 1.8rem;
            font-weight: bold;
            color: var(--primary);
            margin: 5px 0;
        }
        
        .metric-label {
            font-size: 0.9rem;
            color: var(--dark);
        }
        
        .evaluation {
            margin: 15px 0;
            padding: 15px;
            background-color: white;
            border-radius: 10px;
            font-size: 1rem;
        }
        
        .motivational-message {
            text-align: center;
            margin: 10px 0;
            padding: 10px;
            background-color: #e8f4fc;
            border-radius: 8px;
            font-style: italic;
            font-weight: bold;
            color: var(--primary);
            font-size: 0.9rem;
        }
        
        .results-buttons {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 15px;
        }
        
        .results-btn {
            padding: 10px 15px;
            border: none;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 0.9rem;
        }
        
        .retry-btn {
            background-color: var(--primary);
            color: white;
        }
        
        .next-btn {
            background-color: var(--success);
            color: white;
        }
        
        .close-modal-btn {
            background-color: var(--danger);
            color: white;
            margin-top: 10px;
            width: 100%;
        }
        
        .level-info {
            margin-top: 40px;
            padding: 25px;
            background-color: #f8f9fa;
            border-radius: 15px;
            text-align: center;
        }
        
        .level-info p {
            margin-bottom: 15px;
            font-size: 1.1rem;
        }
        
        .requirements {
            margin-top: 20px;
            padding: 20px;
            background-color: #f8f9fa;
            border-radius: 15px;
        }
        
        .requirements h3 {
            color: var(--primary);
            margin-bottom: 15px;
        }
        
        .requirements ul {
            list-style-type: none;
        }
        
        .requirements li {
            margin-bottom: 10px;
            padding-left: 25px;
            position: relative;
        }
        
        .requirements li:before {
            content: "‚Ä¢";
            color: var(--primary);
            font-weight: bold;
            position: absolute;
            left: 0;
        }
        
        @media (max-width: 768px) {
            .container {
                border-radius: 15px;
            }
            
            h1 {
                font-size: 2rem;
            }
            
            .text-display {
                font-size: 20px;
                padding: 20px;
            }
            
            button {
                width: 100%;
                justify-content: center;
            }
            
            .level-buttons {
                flex-direction: row;
                flex-wrap: nowrap;
            }
            
            .level-btn {
                min-width: 80px;
                padding: 10px 15px;
                font-size: 0.9rem;
            }
            
            .results-buttons {
                flex-direction: column;
            }
            
            .results-btn {
                width: 100%;
            }
            
            .results-content {
                padding: 15px;
            }
            
            .metric-value {
                font-size: 1.5rem;
            }
        }
        
        @media (max-width: 480px) {
            .level-buttons {
                flex-wrap: wrap;
            }
            
            .level-btn {
                min-width: 70px;
                padding: 8px 12px;
                font-size: 0.8rem;
            }
            
            .mode-selector {
                flex-direction: column;
                gap: 8px;
            }
        }
        
        .confetti {
            position: absolute;
            width: 10px;
            height: 10px;
            background-color: var(--accent);
            opacity: 0;
            z-index: 1;
        }
        
        @keyframes confettiFall {
            0% { 
                transform: translateY(-100px) rotate(0deg); 
                opacity: 1;
            }
            100% { 
                transform: translateY(500px) rotate(360deg); 
                opacity: 0;
            }
        }
        
        .completed-animation {
            animation: pulse 2s infinite;
            text-align: center;
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--success);
            margin: 20px 0;
            display: none;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üèéÔ∏è Carrera de Lectura üèéÔ∏è</h1>
            <p class="subtitle">Mide y mejora tu velocidad lectora</p>
        </header>
        
        <div class="content">
            <div class="level-section">
                <div class="level-buttons">
                    <button class="level-btn easy active" data-level="easy">F√°cil</button>
                    <button class="level-btn medium" data-level="medium">Medio</button>
                    <button class="level-btn hard" data-level="hard">Dif√≠cil</button>
                </div>
                
                <div class="mode-selector">
                    <span class="mode-label">Manual</span>
                    <label class="switch">
                        <input type="checkbox" id="modeToggle">
                        <span class="slider"></span>
                    </label>
                    <span class="mode-label">Autom√°tico</span>
                </div>
            </div>
            
            <div class="text-container">
                <div class="text-display" id="textDisplay">
                    Selecciona un nivel y presiona "Comenzar" para iniciar la prueba de lectura
                </div>
                <div class="word-count" id="wordCount"></div>
            </div>
            
            <div class="progress-container">
                <div class="progress-bar">
                    <div class="progress" id="progressBar"></div>
                </div>
                <div class="status">
                    <span>Tiempo: <span id="timeElapsed">0</span>s</span>
                    <span>Palabras: <span id="wordsCount">0</span>/<span id="totalWords">0</span></span>
                </div>
            </div>
            
            <div class="mic-status" id="micStatus"></div>
            
            <div class="controls">
                <button id="startButton">
                    <span>üé§</span> Comenzar
                </button>
                <button id="stopButton" disabled>
                    <span>‚èπÔ∏è</span> Detener
                </button>
            </div>
            
            <div class="completed-animation" id="completedAnimation">
                ¬°Felicidades! Has completado todos los niveles üéâ
            </div>
            
            <div class="level-info">
                <p>Para ni√±os de 10 a√±os, se espera una velocidad m√≠nima de <strong>130 palabras por minuto</strong> con buena comprensi√≥n. ¬°Practica y mejora tu velocidad!</p>
            </div>
            
            <div class="requirements">
                <h3>Requisitos del Sistema</h3>
                <ul>
                    <li>Conexi√≥n HTTPS (obligatoria para el reconocimiento de voz)</li>
                    <li>Navegador compatible: Chrome, Edge, Firefox o Safari</li>
                    <li>Micr√≥fono funcionando correctamente (para modo autom√°tico)</li>
                    <li>Permitir el acceso al micr√≥fono cuando el navegador lo solicite</li>
                </ul>
            </div>
        </div>
    </div>

    <div class="results-modal" id="resultsModal">
        <div class="results-content">
            <button class="close-results" id="closeResults">√ó</button>
            <h2 class="result-title">Resultados</h2>
            
            <div class="motivational-message" id="modalMotivation"></div>
            
            <div class="metric">
                <div class="metric-value" id="modalWordsPerMinute">0</div>
                <div class="metric-label">Palabras por minuto</div>
            </div>
            
            <div class="metric">
                <div class="metric-value" id="modalAccuracy">0%</div>
                <div class="metric-label">Precisi√≥n</div>
            </div>
            
            <div class="metric">
                <div class="metric-value" id="modalReadingTime">0s</div>
                <div class="metric-label">Tiempo de lectura</div>
            </div>
            
            <div class="evaluation" id="modalEvaluation">
                ¬°Sigue practicando para mejorar tu velocidad!
            </div>
            
            <div class="results-buttons">
                <button class="results-btn retry-btn" id="modalRetry">
                    <span>üîÑ</span> Intentar de nuevo
                </button>
                <button class="results-btn next-btn" id="modalNext">
                    <span>‚û°Ô∏è</span> Siguiente texto
                </button>
            </div>
            
            <button class="close-modal-btn" id="modalClose">
                Cerrar
            </button>
        </div>
    </div>

    <script>
        // Textos para cada nivel (9 textos por nivel)
        const textsByLevel = {
            easy: [
                "El sol brilla en el cielo azul. Los p√°jaros cantan en los √°rboles. Los ni√±os juegan en el parque con una pelota roja. Hace un d√≠a muy bonito y todos est√°n contentos.",
                "Mar√≠a tiene un perrito peque√±o que se llama Luna. A Luna le gusta correr en el jard√≠n y jugar con su pelota favorita. Por las tardes, Mar√≠a y Luna pasean por el barrio.",
                "En la granja hay muchos animales. Los pollitos p√≠an, las vacas dan leche y los cerdos juegan en el lodo. El granjero da de comer a todos cada ma√±ana.",
                "Carlos va al colegio en autob√∫s. Su mochila tiene libros, l√°pices de colores y su merienda favorita. En el recreo, juega al f√∫tbol con sus amigos.",
                "La abuela hace galletas de chocolate los domingos. Su casa huele muy bien cuando las galletas est√°n en el horno. Todos los nietos esperan con ilusi√≥n probarlas.",
                "En el mar nadan peces de muchos colores. Algunos son rojos, otros azules y los hay amarillos. Las olas suben y bajan suavemente en la orilla.",
                "El superh√©roe vuela por la ciudad salvando a las personas. Lleva una capa roja y tiene superfuerza. Todos los ni√±os admiran sus aventuras.",
                "En invierno hace fr√≠o y a veces nieva. Los ni√±os se ponen abrigos gruesos, gorros y guantes. Les gusta hacer mu√±ecos de nieve en el jard√≠n.",
                "La princesa vive en un castillo muy grande con torres altas. Tiene un vestido brillante y una corona de oro. Por las noches, baila en el gran sal√≥n."
            ],
            medium: [
                "Los exploradores se adentraron en el bosque misterioso buscando antiguas ruinas ocultas entre la vegetaci√≥n. Con sus mapas y br√∫julas, avanzaron cuidadosamente por el sendero cubierto de hojas secas.",
                "La abuela preparaba cada domingo un delicioso pastel de manzana con canela. Su casa se llenaba de un aroma dulce que atra√≠a a todos los nietos hacia la cocina, donde esperaban ansiosos el postre.",
                "El equipo de cient√≠ficos descubri√≥ una nueva especie de mariposa en la selva tropical. Sus alas ten√≠an colores vibrantes que nunca antes se hab√≠an documentado en ning√∫n libro de biolog√≠a.",
                "El astronauta flotaba en la estaci√≥n espacial observando la Tierra through la ventana circular. Contemplaba los continentes, oc√©anos y nubes desde su privilegiada perspectiva en √≥rbita.",
                "La biblioteca municipal albergaba miles de libros ordenados meticulosamente en estanter√≠as de roble. Los estudiantes acud√≠an cada tarde a consultar enciclopedias y novelas cl√°sicas.",
                "El arquitecto dise√±√≥ un rascacielos innovador con fachada de cristal y sistemas de energ√≠a sostenible. Su estructura se elevaba hacia el cielo desafiando las leyes de la gravedad.",
                "El concertista afin√≥ su viol√≠n antes del recital en el auditorio abarrotado. Las notas musicales flotaban en el aire creando una atm√≥sfera m√°gica para el p√∫blico expectante.",
                "Los periodistas investigaban el caso misterioso que ten√≠a intrigadas a las autoridades. Revisaban documentos antiguos y entrevistaban testigos para reconstruir los hechos.",
                "El deportista ol√≠mpico entrenaba cada madrugada en el estadio vac√≠o. Su disciplina y dedicaci√≥n eran admirables, persiguiendo el sue√±o de una medalla para su pa√≠s."
            ],
            hard: [
                "La civilizaci√≥n egipcia antigua desarroll√≥ avanzados sistemas de irrigaci√≥n que permitieron la agricultura en las √°ridas tierras cercanas al r√≠o Nilo. Construyeron impresionantes pir√°mides que a√∫n hoy siguen maravillando a arque√≥logos y turistas.",
                "Los fen√≥menos meteorol√≥gicos extremos, como huracanes y tornados, se han intensificado debido al cambio clim√°tico global. Los investigadores analizan datos satelitales para mejorar los sistemas de alerta temprana.",
                "La revoluci√≥n industrial del siglo XVIII transform√≥ profundamente la econom√≠a y la sociedad europea. La invenci√≥n de m√°quinas a vapor permiti√≥ la producci√≥n en masa y cambi√≥ para siempre las relaciones laborales.",
                "El sistema digestivo humano procesa los alimentos mediante complejos procesos enzim√°ticos y mec√°nicos. Cada √≥rgano cumple una funci√≥n espec√≠fica en la transformaci√≥n de nutrientes para su absorci√≥n.",
                "Las teor√≠as cu√°nticas revolucionaron la f√≠sica tradicional al introducir conceptos probabil√≠sticos en el comportamiento de part√≠culas subat√≥micas. Este paradigma desafi√≥ los principios newtonianos establecidos.",
                "La diplomacia internacional requiere habilidades de negociaci√≥n, conocimiento cultural y comprensi√≥n de geopol√≠tica. Los acuerdos entre naciones moldean el equilibrio de poder mundial.",
                "La fotos√≠ntesis es el proceso bioqu√≠mico mediante el cual las plantas transforman la energ√≠a lum√≠nica en energ√≠a qu√≠mica. Este mecanismo vital sustenta la mayor√≠a de los ecosistemas terrestres.",
                "El renacimiento art√≠stico floreci√≥ en Italia propagando ideas humanistas que valoraban el potencial individual y el retorno a las fuentes cl√°sicas del conocimiento grecorromano.",
                "La neurolog√≠a cognitiva estudia las bases biol√≥gicas de procesos mentales como la memoria, atenci√≥n y percepci√≥n. Las neuroim√°genes permiten visualizar la actividad cerebral en tiempo real."
            ]
        };
        
        // Mensajes motivacionales
        const motivationalMessages = [
            "¬°Excelente lectura! Sigue as√≠.",
            "¬°Gran trabajo! Cada d√≠a lees mejor.",
            "¬°Incre√≠ble! Tu esfuerzo est√° dando resultados.",
            "¬°Fant√°stico! Eres un lector excepcional.",
            "¬°Maravilloso! Tu velocidad mejora constantemente.",
            "¬°Impresionante! Nada puede detenerte ahora.",
            "¬°Asombroso! Tu dedicaci√≥n es admirable."
        ];
        
        // Variables del juego
        let currentText = "";
        let startTime, endTime;
        let recognition;
        let wordsRead = 0;
        let correctWords = 0;
        let isTesting = false;
        let progressInterval;
        let isManualMode = false;
        let audioContext;
        let currentLevel = "easy";
        let usedTexts = { easy: [], medium: [], hard: [] };
        let playerStats = { easy: [], medium: [], hard: [] };
        
        // Elementos DOM
        const startButton = document.getElementById('startButton');
        const stopButton = document.getElementById('stopButton');
        const modeToggle = document.getElementById('modeToggle');
        const levelButtons = document.querySelectorAll('.level-btn');
        const resultsModal = document.getElementById('resultsModal');
        const closeResults = document.getElementById('closeResults');
        const modalRetry = document.getElementById('modalRetry');
        const modalNext = document.getElementById('modalNext');
        const modalClose = document.getElementById('modalClose');
        const modalMotivation = document.getElementById('modalMotivation');
        
        // Inicializar la aplicaci√≥n
        function initApp() {
            // Cargar estad√≠sticas desde cookies
            loadPlayerStats();
            
            // Configurar event listeners
            startButton.addEventListener('click', startTest);
            stopButton.addEventListener('click', stopTest);
            modeToggle.addEventListener('change', toggleMode);
            closeResults.addEventListener('click', closeModal);
            modalRetry.addEventListener('click', () => {
                closeModal();
                resetTest();
            });
            modalNext.addEventListener('click', () => {
                closeModal();
                resetTest();
                startTest();
            });
            modalClose.addEventListener('click', closeModal);
            
            levelButtons.forEach(btn => {
                btn.addEventListener('click', () => {
                    changeLevel(btn.dataset.level);
                });
            });
            
            // Inicializar audio
            try {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
            } catch (e) {
                console.error('Web Audio API no es compatible con este navegador:', e);
            }
            
            // Verificar si estamos en HTTPS
            if (location.protocol !== 'https:') {
                document.getElementById('micStatus').innerHTML = 
                    '<span style="color: var(--danger);">‚ö†Ô∏è Esta aplicaci√≥n requiere HTTPS para funcionar correctamente.</span>';
            }
        }
        
        // Cargar estad√≠sticas del jugador desde cookies
        function loadPlayerStats() {
            const statsCookie = getCookie('readingStats');
            if (statsCookie) {
                playerStats = JSON.parse(statsCookie);
            }
            
            const usedCookie = getCookie('usedTexts');
            if (usedCookie) {
                usedTexts = JSON.parse(usedCookie);
            }
        }
        
        // Guardar estad√≠sticas del jugador en cookies
        function savePlayerStats() {
            setCookie('readingStats', JSON.stringify(playerStats), 30);
            setCookie('usedTexts', JSON.stringify(usedTexts), 1); // Caduca en 1 d√≠a
        }
        
        // Funciones de cookies
        function setCookie(name, value, days) {
            const date = new Date();
            date.setTime(date.getTime() + (days * 24 * 60 * 60 * 1000));
            const expires = "expires=" + date.toUTCString();
            document.cookie = name + "=" + value + ";" + expires + ";path=/";
        }
        
        function getCookie(name) {
            const nameEQ = name + "=";
            const ca = document.cookie.split(';');
            for(let i = 0; i < ca.length; i++) {
                let c = ca[i];
                while (c.charAt(0) === ' ') c = c.substring(1, c.length);
                if (c.indexOf(nameEQ) === 0) return c.substring(nameEQ.length, c.length);
            }
            return null;
        }
        
        // Cambiar nivel de dificultad
        function changeLevel(level) {
            currentLevel = level;
            
            // Actualizar botones de nivel
            levelButtons.forEach(btn => {
                if (btn.dataset.level === level) {
                    btn.classList.add('active');
                } else {
                    btn.classList.remove('active');
                }
            });
            
            // Reiniciar la prueba
            resetTest();
        }
        
        // Cambiar modo (autom√°tico/manual)
        function toggleMode() {
            isManualMode = !modeToggle.checked;
            resetTest();
            
            if (isManualMode) {
                document.getElementById('micStatus').textContent = 'Modo manual: el profesor calcular√° el tiempo';
            } else {
                document.getElementById('micStatus').textContent = 'Modo autom√°tico: el sistema escuchar√° la lectura';
            }
        }
        
        // Obtener un texto aleatorio que no se haya usado
        function getRandomText() {
            const availableTexts = [];
            
            // Encontrar textos no utilizados
            for (let i = 0; i < textsByLevel[currentLevel].length; i++) {
                if (!usedTexts[currentLevel].includes(i)) {
                    availableTexts.push(i);
                }
            }
            
            // Si todos los textos se han usado, reiniciar
            if (availableTexts.length === 0) {
                usedTexts[currentLevel] = [];
                for (let i = 0; i < textsByLevel[currentLevel].length; i++) {
                    availableTexts.push(i);
                }
            }
            
            // Seleccionar un texto aleatorio
            const randomIndex = Math.floor(Math.random() * availableTexts.length);
            const textIndex = availableTexts[randomIndex];
            
            // Marcar como usado
            usedTexts[currentLevel].push(textIndex);
            savePlayerStats();
            
            return textsByLevel[currentLevel][textIndex];
        }
        
        // Inicializar el reconocimiento de voz
        function initSpeechRecognition() {
            window.SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            
            if (!window.SpeechRecognition) {
                alert("Lo sentimos, tu navegador no soporta reconocimiento de voz. Prueba con Chrome o Edge.");
                return false;
            }
            
            recognition = new SpeechRecognition();
            recognition.lang = 'es-ES';
            recognition.continuous = true;
            recognition.interimResults = true;
            
            recognition.onresult = function(event) {
                if (!isTesting || isManualMode) return;
                
                for (let i = event.resultIndex; i < event.results.length; i++) {
                    if (event.results[i].isFinal) {
                        const transcript = event.results[i][0].transcript;
                        processSpeech(transcript);
                    }
                }
            };
            
            recognition.onerror = function(event) {
                console.error('Error en reconocimiento de voz:', event.error);
                document.getElementById('micStatus').textContent = 'Error: ' + event.error;
            };
            
            recognition.onend = function() {
                if (isTesting && !isManualMode) {
                    try {
                        recognition.start();
                    } catch (e) {
                        console.error('Error al reiniciar reconocimiento:', e);
                    }
                }
            };
            
            return true;
        }
        
        // Comenzar la prueba
        function startTest() {
            if (!isManualMode && !initSpeechRecognition()) return;
            
            // Obtener texto aleatorio no usado
            currentText = getRandomText();
            const totalWords = currentText.split(/\s+/).length;
            
            // Mostrar texto
            const textDisplay = document.getElementById('textDisplay');
            textDisplay.textContent = currentText;
            
            // Mostrar conteo de palabras
            document.getElementById('totalWords').textContent = totalWords;
            document.getElementById('wordCount').textContent = `${totalWords} palabras`;
            
            // Reiniciar variables
            wordsRead = 0;
            correctWords = 0;
            startTime = new Date();
            isTesting = true;
            
            // Actualizar UI
            startButton.disabled = true;
            stopButton.disabled = false;
            document.getElementById('progressBar').style.width = '0%';
            
            if (isManualMode) {
                document.getElementById('micStatus').textContent = '¬°Empieza a leer ahora!';
            } else {
                document.getElementById('micStatus').textContent = 'Escuchando... Habla ahora!';
            }
            
            document.getElementById('wordsCount').textContent = '0';
            document.getElementById('timeElapsed').textContent = '0';
            
            // Reproducir sonido de inicio
            playStartSound();
            
            // Iniciar reconocimiento de voz si est√° en modo autom√°tico
            if (!isManualMode) {
                try {
                    recognition.start();
                } catch (error) {
                    console.error("Error al iniciar reconocimiento:", error);
                }
            }
            
            // Actualizar barra de progreso cada segundo
            progressInterval = setInterval(updateProgress, 1000);
        }
        
        // Actualizar progreso
        function updateProgress() {
            if (!isTesting) {
                clearInterval(progressInterval);
                return;
            }
            
            const elapsedTime = Math.floor((new Date() - startTime) / 1000);
            document.getElementById('timeElapsed').textContent = elapsedTime;
            
            const progressPercent = Math.min(100, (elapsedTime / 60) * 100);
            document.getElementById('progressBar').style.width = progressPercent + '%';
            
            // Detener autom√°ticamente despu√©s de 120 segundos
            if (elapsedTime > 120) {
                stopTest();
            }
        }
        
        // Procesar el habla detectada
        function processSpeech(transcript) {
            const expectedWords = currentText.toLowerCase().replace(/[.,]/g, '').split(/\s+/);
            const spokenWords = transcript.toLowerCase().replace(/[.,]/g, '').split(/\s+/);
            
            wordsRead = spokenWords.length;
            document.getElementById('wordsCount').textContent = wordsRead;
            
            // Verificar palabras correctas
            correctWords = 0;
            for (let i = 0; i < spokenWords.length; i++) {
                if (i < expectedWords.length && spokenWords[i] === expectedWords[i]) {
                    correctWords++;
                }
            }
        }
        
        // Detener la prueba
        function stopTest() {
            if (!isTesting) return;
            
            isTesting = false;
            endTime = new Date();
            clearInterval(progressInterval);
            
            // Detener reconocimiento de voz si est√° activo
            if (!isManualMode && recognition) {
                try {
                    recognition.stop();
                } catch (error) {
                    console.error("Error al detener reconocimiento:", error);
                }
            }
            
            // Calcular resultados
            const timeInSeconds = (endTime - startTime) / 1000;
            const timeInMinutes = timeInSeconds / 60;
            const totalWords = currentText.split(/\s+/).length;
            
            // En modo manual, calcular palabras le√≠das basado en el texto completo
            if (isManualMode) {
                wordsRead = totalWords;
                correctWords = totalWords; // Asumimos que se leyeron todas correctamente en modo manual
            }
            
            const wordsPerMinute = Math.round(wordsRead / timeInMinutes);
            const accuracy = wordsRead > 0 ? Math.round((correctWords / wordsRead) * 100) : 0;
            
            // Guardar estad√≠sticas
            playerStats[currentLevel].push({
                wpm: wordsPerMinute,
                accuracy: accuracy,
                time: timeInSeconds,
                date: new Date().toISOString()
            });
            savePlayerStats();
            
            // Evaluar rendimiento
            let evaluation = "";
            let minimumWPM = 130;
            
            // Ajustar expectativas seg√∫n nivel
            if (currentLevel === "easy") minimumWPM = 110;
            if (currentLevel === "hard") minimumWPM = 150;
            
            if (wordsPerMinute >= minimumWPM && accuracy >= 85) {
                evaluation = "¬°Excelente! Tu velocidad de lectura es muy buena para este nivel.";
            } else if (wordsPerMinute >= minimumWPM - 20 && accuracy >= 75) {
                evaluation = "Buen trabajo. Sigue practicando para mejorar tu velocidad y precisi√≥n.";
            } else {
                evaluation = "Sigue practicando. La lectura mejora con la pr√°ctica constante.";
            }
            
            // Mostrar resultados en el modal
            showResultsModal(wordsPerMinute, accuracy, timeInSeconds, evaluation);
            
            // Actualizar UI
            startButton.disabled = false;
            stopButton.disabled = true;
            
            if (isManualMode) {
                document.getElementById('micStatus').textContent = 'Prueba finalizada';
            } else {
                document.getElementById('micStatus').textContent = 'Prueba finalizada - ' + correctWords + ' de ' + wordsRead + ' palabras correctas';
            }
            
            // Reproducir sonido de celebraci√≥n si fue exitoso
            if (wordsPerMinute >= minimumWPM && accuracy >= 85) {
                playCelebrationSound();
            }
        }
        
        // Mostrar modal de resultados
        function showResultsModal(wpm, accuracy, time, evaluation) {
            document.getElementById('modalWordsPerMinute').textContent = wpm;
            document.getElementById('modalAccuracy').textContent = accuracy + '%';
            document.getElementById('modalReadingTime').textContent = time.toFixed(1) + 's';
            document.getElementById('modalEvaluation').textContent = evaluation;
            
            // Mostrar mensaje motivacional aleatorio
            const randomMessage = motivationalMessages[Math.floor(Math.random() * motivationalMessages.length)];
            document.getElementById('modalMotivation').textContent = randomMessage;
            
            resultsModal.style.display = 'flex';
        }
        
        // Cerrar modal de resultados
        function closeModal() {
            resultsModal.style.display = 'none';
        }
        
        // Reiniciar la prueba
        function resetTest() {
            const textDisplay = document.getElementById('textDisplay');
            textDisplay.textContent = 'Presiona "Comenzar" para iniciar la prueba';
            
            document.getElementById('progressBar').style.width = '0%';
            document.getElementById('timeElapsed').textContent = '0';
            document.getElementById('wordsCount').textContent = '0';
            document.getElementById('totalWords').textContent = '0';
            document.getElementById('wordCount').textContent = '';
            
            if (isManualMode) {
                document.getElementById('micStatus').textContent = 'Modo manual: el profesor calcular√° el tiempo';
            } else {
                document.getElementById('micStatus').textContent = 'Modo autom√°tico: el sistema escuchar√° la lectura';
            }
        }
        
        // Reproducir sonido de inicio
        function playStartSound() {
            if (!audioContext) return;
            
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            
            oscillator.frequency.setValueAtTime(440, audioContext.currentTime);
            oscillator.frequency.setValueAtTime(523.25, audioContext.currentTime + 0.1);
            
            gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.3);
            
            oscillator.start();
            oscillator.stop(audioContext.currentTime + 0.3);
        }
        
        // Reproducir sonido de celebraci√≥n
        function playCelebrationSound() {
            if (!audioContext) return;
            
            try {
                // Crear una secuencia de tonos celebratorios
                const times = [0, 0.1, 0.2, 0.3, 0.4, 0.5];
                const frequencies = [523.25, 587.33, 659.25, 698.46, 783.99, 880];
                
                for (let i = 0; i < times.length; i++) {
                    const oscillator = audioContext.createOscillator();
                    const gainNode = audioContext.createGain();
                    
                    oscillator.connect(gainNode);
                    gainNode.connect(audioContext.destination);
                    
                    oscillator.frequency.setValueAtTime(frequencies[i], audioContext.currentTime);
                    
                    gainNode.gain.setValueAtTime(0.3, audioContext.currentTime + times[i]);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + times[i] + 0.1);
                    
                    oscillator.start(audioContext.currentTime + times[i]);
                    oscillator.stop(audioContext.currentTime + times[i] + 0.1);
                }
            } catch (e) {
                console.error('Error reproduciendo sonido:', e);
            }
        }
        
        // Inicializar cuando se carga la p√°gina
        window.addEventListener('load', initApp);
    </script>
</body>
</html>
